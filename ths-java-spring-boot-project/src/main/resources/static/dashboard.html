<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <script type="module">
        import { apiFetch } from "./js/apiFetch.js";
        import { formatDateTime } from "./js/datetime-utils.js";
        import { logout } from "./js/auth.js";
        import { setupBooksButton } from "./js/booksButton.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'none';  // hide previous error

            // Get JWT token from localStorage
            const token = localStorage.getItem('jwt_token');

            // If no token, redirect to login page
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                // Fetch user profile from API
                const response = await apiFetch('/api/users/profile');

                // Handle unauthorized or failed response
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token invalid or expired, redirect to login
                        localStorage.removeItem('jwt_token');
                        window.location.href = '/login';
                        return;
                    }

                    throw new Error(`Failed to load profile: ${response.status}`);
                }

                // Populate dashboard with profile info
                const profile = await response.json();
                document.getElementById('userEmail').textContent = profile.email;
                document.getElementById('userFirstName').textContent = profile.firstName;
                document.getElementById('userLastName').textContent = profile.lastName;
                // Unresolved variable registrationDate - only IDE warning
                document.getElementById('userRegistrationDate').textContent =
                    formatDateTime(profile.registrationDate);
                document.getElementById('userRole').textContent = profile.role;
                document.getElementById('userFirstName2').textContent = profile.firstName;
            } catch (error) {
                // Display error message to the user
                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            logout();
        });

        setupBooksButton("books-button", "books-list", "books-pagination");
    </script>
</head>
<body>
    <header>
        <h2>Dashboard</h2>

        <!-- Logout button -->
        <button id="logoutButton">Logout</button>

        <p>Welcome, <span id="userFirstName">loading...</span>!</p>
    </header>

    <main>
        <p><strong>Email:</strong> <span id="userEmail">loading...</span></p>
        <p><strong>First name:</strong> <span id="userFirstName2">loading...</span></p>
        <p><strong>Last name:</strong> <span id="userLastName">loading...</span></p>
        <p><strong>Role:</strong> <span id="userRole">loading...</span></p>
        <p><strong>Member since:</strong> <span id="userRegistrationDate">loading...</span></p>
    </main>

    <!-- Error messages appear here -->
    <div id="error" class="error"></div>

    <div class="actions">
        <h3>Actions</h3>
        <button id="books-button">Books</button>
        <ul id="books-list"></ul>
        <div id="books-pagination"></div>
    </div>
</body>
</html>
